<!doctype html>
<html lang="en">

<head>
    <meta charset="utf--8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RoboResume - Resume Builder Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 960px;
        }

        .card {
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        pre {
            white-space: pre-wrap;
            word-break: break-word;
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.25rem;
        }

        .accordion-button:not(.collapsed) {
            background-color: #e7f1ff;
        }

        .keyword-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            height: 150px;
        }

        .info-badge {
            background-color: #e3f2fd;
            border: 1px solid #bbdefb;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .btn-group-custom {
            gap: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container mt-5 mb-5">
        <h1 class="text-center mb-2">Resume Builder Setup</h1>
        <p class="text-center text-muted mb-4">Configure your career profile and preferences, then let AI build your
            perfect resume.</p>

        <form action="{{ url_for('run_step3_tailoring', session_id=session_id) }}" method="post"
            enctype="multipart/form-data">

            <div class="accordion mb-4" id="jobDataAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseJobData"><strong>üìä View Job Analysis
                                Results</strong></button></h2>
                    <div id="collapseJobData" class="accordion-collapse collapse" data-bs-parent="#jobDataAccordion">
                        <div class="accordion-body">
                            <h5 class="text-muted">Ideal Candidate Profile</h5>
                            <pre><code>{{ json_content }}</code></pre>
                            <h5 class="text-muted mt-3">Original Job Posting</h5>
                            <pre><code>{{ markdown_content }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-4">
                <div class="card-body">
                    <div class="info-badge">
                        <h6 class="mb-2">üöÄ How the Resume Builder Works</h6>
                        <p class="mb-0 small">The AI will analyze your comprehensive career profile and intelligently
                            select the most relevant achievements and skills based on the job requirements. It builds
                            each section from scratch rather than just rewriting an existing resume.</p>
                    </div>

                    <div class="mb-4">
                        <label for="resume_file" class="form-label">
                            <h5>1. Upload Your Career Profile</h5>
                        </label>
                        <input class="form-control" type="file" id="resume_file" name="resume_file" accept=".json">
                        <div class="form-text">
                            <strong>üìÅ Expected format:</strong> user_profile.json with tagged achievements.<br>
                            <strong>üîß If left blank:</strong> Default career profile will be used:
                            <code>data/resume_assets/user_profile.json</code><br>
                            <small class="text-muted">Your profile should contain your complete work history with
                                achievements tagged by skills (e.g., "python", "leadership", "data-analysis").</small>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <h5>2. Customize Keywords & Focus Areas</h5>
                        <p class="text-muted">Add, edit, or remove keywords to emphasize specific skills in the final
                            resume. These will be prioritized during content selection.</p>
                        <textarea id="keywordEditor" class="form-control keyword-editor"
                            placeholder="Enter one keyword per line...">{% for keyword in keywords %}{{ keyword.strip() }}
{% endfor %}</textarea>
                        <button type="button" class="btn btn-outline-primary mt-2"
                            onclick="updatePromptPreview()">Update Builder Preview</button>
                        <input type="hidden" id="finalKeywords" name="final_keywords" value="{{ keywords|join(',') }}">
                    </div>

                    <hr class="my-4">

                    <div class="mb-4">
                        <h5>3. Preview Resume Builder Process</h5>
                        <div class="accordion" id="promptAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapsePrompt"><strong>ü§ñ View AI
                                            Resume Builder Instructions</strong></button></h2>
                                <div id="collapsePrompt" class="accordion-collapse collapse show"
                                    data-bs-parent="#promptAccordion">
                                    <div class="accordion-body">
                                        <div class="small text-muted mb-2">The AI will use these instructions to
                                            intelligently build your resume:</div>
                                        <pre class="mt-2"><code id="promptPreview">{{ prompt }}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('review_joblisting', session_id=session_id) }}"
                            class="btn btn-secondary btn-lg">‚Üê Back to Job Review</a>
                        <button type="submit" class="btn btn-primary btn-lg">üöÄ Build Resume</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const basePrompt = {{ prompt | tojson }};

        function updatePromptPreview() {
            const keywordEditor = document.getElementById('keywordEditor');
            const finalKeywordsInput = document.getElementById('finalKeywords');
            const promptPreview = document.getElementById('promptPreview');

            // Get keywords from textarea, split by newline, trim whitespace, and filter empty lines
            const keywords = keywordEditor.value.split('\n')
                .map(k => k.trim())
                .filter(k => k.length > 0);

            // Update the hidden input for form submission
            finalKeywordsInput.value = keywords.join(',');

            let keywordInjectionText = "";
            if (keywords.length > 0) {
                const keywordList = keywords.join(', ');
                keywordInjectionText = `\n\n**Additional Keywords to Prioritize:** ${keywordList}`;
            }

            // Update the preview display
            promptPreview.textContent = basePrompt + keywordInjectionText;
        }

        // Run once on page load to initialize the prompt preview
        document.addEventListener('DOMContentLoaded', function () {
            updatePromptPreview();
        });
    </script>
</body>

</html>